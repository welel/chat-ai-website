# 1. Цель проекта

**Цель проекта** — разработать веб-сайт для ведения диалога с персонализированной моделью искусственного интеллекта.

Персонализированная модель искусственного интеллекта (далее Персонаж) - модель искусственного интеллекта, способная вести диалог с пользователем и принимать роль персонажа (известной личности, персонажа из виртуальной реальности или искусства, личности определенной группы).

Пользователь на сайте выбирает Персонажа и ведет с ней диалог в чате.

Общая задача: развлекательная. 

# 2. Описание системы

Система состоит из следующих основных функциональных блоков:

1. Регистрация, аутентификация.
2. Функционал генерации ответов моделью.
3. Функционал персонализации и создание персонажей.
4. Функционал чата.

Стек технологий:

- Django
- PostgreSQL
- Redis
- Celery
- Websockets
- Bootstrap

## Схема базы данных

Главные сущности:

- Пользователь (модель Django)
- Персонаж
- Чат
- Сообщение

**Персонаж**
| Поле                  | Тип      | Описание                                           |
| --------------------- | -------- | -------------------------------------------------- |
| id                    | number   | Идентификатор                                      |
| character_name        | string   | Название персонажа в карточке                      |
| description           | string   | Короткое описание, появляющееся в карточке         |
| avatar                | string   | Путь к аватару модели                              |
| greeting              | string   | Приветствие модели (первое сообщение в чат)        |
| model_name            | string   | Название персонажа при взаимодействии с моделью    |
| user_name             | string   | Название пользователя при взаимодействии с моделью |
| model_description     | string   | Самоопределение персонажа для модели               |
| situation_description | string   | Описание контекста беседы для модели               |
| visibility            | bool     | Видимость Персонажа                                |
| created               | datetime | Время создания                                     | 

**Чат**
| Поле         | Тип      | Описание                   |
| ------------ | -------- | -------------------------- |
| id           | number   | Идентификатор              |
| user_id      | number   | Идентификатор пользователя |
| character_id | number   | Идентификатор Персонажа    |
| created      | datetime | Время создания             |
| last_message | datetime | Время последнего сообщения |

**Сообщение**
| Поле      | Тип      | Описание                  |
| --------- | -------- | ------------------------- |
| id        | number   | Идентификатор             |
| chat_id   | number   | Идентификатор чата        |
| sender_id | number   | Идентификатор отправителя |
| created   | datetime | Время отправки            |
| content   | string   | Текст сообщения           |

## 2.1.1. Регистрация

Регистрация будет осуществляться стандартными средствами Django. У пользователя пока не планируются дополнительные поля. Обязательными полями являются - email (уникальный), password.

Дополнительные средства регистрации - Oauth2:

- Google
- GitHub
- Yandex

## 2.1.2. Аутентификация

Аутентификация осуществляется по средствам Oauth2 или при предоставлении пары email, password.

## 2.1.3. Остальной функционал

Дополнительный функционал пока не предусматривается. Нет подтверждения email, смены email и пароля.


## 2.2. Генерации ответов моделью

Для генерации ответов используется OpenAI API, модель "text-davinci-003".

- Работа с API вынесена в отдельный пакет,
- используется функциональное программирование,
- запросы к API асинхронные.

Функции работают только с промптами и отдают ответы; функции вызываются в сервисах или контроллерах. Необходимо написать внешнюю валидацию для промптов и ответов.

Для асинхронности будет использоваться Celery, следует его гибко настроить: предусмотреть throttling, retry, логгирование.

## 2.3. Персонажи

Персонаж описывается набором данных, необходимых для составления запроса к OpenAI модели.

Действия с персонажами:

- Создание
- Редактирование
- Удаление
- Изменение видимости

**Описание полей:**
| Поле                  | Обязательно (по-умолчанию)      | Описание                                               |
| --------------------- | -------- | ------------------------------------------------------ |
| character_name        | +   | Название персонажа для отображения в интерфейсе        |
| description           | - (пустая строка)   | Короткое описание модели, для отображения в интерфейсе | 
| avatar                | - (картинка по-умолчанию)  | Путь к аватару модели                                  |
| greeting              | + (стандартное для всех приветствие)  | Приветствие модели (первое сообщение в чат)            |
| model_name            | + (Ассистент)  | Название персонажа при взаимодействии с моделью (используется для генерации промпта в качестве имени собеседника в диалоге)        |
| user_name             | + (Человек)  | Название пользователя при взаимодействии с моделью (используется для генерации промпта в качестве имени собеседника в диалоге)     |
| model_description     | - (пустая строка)  | Самоопределение персонажа для модели (описание персонажа, его характера, особенностей, задач и т.п., используется в начале промпта)                  |
| situation_description | -  (пустая строка) | Описание контекста беседы для модели (описание контекста, настроения беседы, используется в начале промпта)                   |
| visibility            | + (приват)    | Видимость Персонажа для других пользователей                                    |
| created               | + (now) | Время создания                                         |

## 2.4. Чат и сообщения

Все чаты создаются 1х1 (модель с пользователем). С одной моделью пользователь может создать несколько чатов. Чат создаётся при выборе персонажа. Удаляется по инициативе пользователя. У анонимных пользователей есть возможность ограниченно воспользоваться чатом (несколько сообщений).

После отправки сообщения пользователем, происходит генерация ответа от модели. За генерацию отвечает отдельная сущность, которая имеет информацию о чате. Генерация и обращения к OpenAI API происходит в фоновом режиме.

У пользователя есть возможность удалять сообщения. При удалении сообщения, удаляются всё сообщения, которые были отправлены после удаленного.
